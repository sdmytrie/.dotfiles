"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NxImportsPlugin = void 0;
const path_1 = require("path");
const isNxImportPlugin = Symbol('__isNxImportPlugin__');
class NxImportsPlugin {
    constructor(typescript) {
        this.typescript = typescript;
        this.config = {};
        this.projects = new Map();
    }
    setConfig(config) {
        this.logger?.log('setting configuration ' + JSON.stringify(config));
        this.config = config;
        this.projects.forEach((project) => {
            this.updateProject(project);
        });
    }
    addProject(project) {
        this.logger?.log('addProject ' + project.getProjectName());
        if (this.projects.has(project.getProjectName())) {
            this.logger?.log('project already tracked ' + project.getProjectName());
            return;
        }
        this.projects.set(project.getProjectName(), project);
        this.updateProject(project);
    }
    updateProject(project) {
        this.logger?.log('updating project: ' + project.getProjectName());
        const externals = this.getRootFiles(project);
        externals.forEach((external) => {
            project.addMissingFileRoot(this.typescript.server.toNormalizedPath(external));
        });
    }
    getRootFiles(project) {
        this.logger?.log('get root files: ' + JSON.stringify(this.config));
        const externalFiles = this.config.externalFiles || [];
        if (externalFiles.length === 0) {
            return [];
        }
        const projectDirectory = path_1.dirname(project.getProjectName());
        this.logger?.log(`project directory: ${projectDirectory}`);
        const filteredExternalFiles = externalFiles
            .filter(({ directory }) => {
            return !projectDirectory.startsWith(directory);
        })
            .map(({ mainFile }) => mainFile);
        this.logger?.log(`root files: ${JSON.stringify(filteredExternalFiles)}`);
        return filteredExternalFiles;
    }
    decorate(languageService) {
        this.logger?.log('decorate');
        if (languageService[isNxImportPlugin]) {
            // Already decorated
            return;
        }
        const intercept = Object.create(null);
        const oldGetCompletionsAtPosition = languageService.getCompletionsAtPosition.bind(languageService);
        intercept.getCompletionsAtPosition = (fileName, position, options) => {
            this.logger?.log(`getCompletionsAtPosition ${fileName}:${position}`);
            return this.getCompletionsAtPosition(oldGetCompletionsAtPosition, fileName, position, options);
        };
        return new Proxy(languageService, {
            get: (target, property) => {
                if (property === isNxImportPlugin) {
                    return true;
                }
                return intercept[property] || target[property];
            },
        });
    }
    getCompletionsAtPosition(delegate, fileName, position, options) {
        return delegate(fileName, position, options);
    }
}
exports.NxImportsPlugin = NxImportsPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibngtaW1wb3J0cy1wbHVnaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy90eXBlc2NyaXB0LW54LWltcG9ydHMtcGx1Z2luL3NyYy9saWIvbngtaW1wb3J0cy1wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0JBQStCO0FBVS9CLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFeEQsTUFBYSxlQUFlO0lBSzFCLFlBQTZCLFVBQTRCO1FBQTVCLGVBQVUsR0FBVixVQUFVLENBQWtCO1FBSHpELFdBQU0sR0FBa0IsRUFBRSxDQUFDO1FBQzNCLGFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBb0MsQ0FBQztJQUVLLENBQUM7SUFFN0QsU0FBUyxDQUFDLE1BQXFCO1FBQzdCLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUVyQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ2hDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsVUFBVSxDQUFDLE9BQWlDO1FBQzFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUMzRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLDBCQUEwQixHQUFHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQ3hFLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNyRCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFTyxhQUFhLENBQUMsT0FBaUM7UUFDckQsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsb0JBQW9CLEdBQUcsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDbEUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3QyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDN0IsT0FBTyxDQUFDLGtCQUFrQixDQUN4QixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FDbEQsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFlBQVksQ0FBQyxPQUFpQztRQUM1QyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ25FLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztRQUV0RCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFFRCxNQUFNLGdCQUFnQixHQUFHLGNBQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxzQkFBc0IsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBRTNELE1BQU0scUJBQXFCLEdBQUcsYUFBYTthQUN4QyxNQUFNLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUU7WUFDeEIsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUM7YUFDRCxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxlQUFlLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFekUsT0FBTyxxQkFBcUIsQ0FBQztJQUMvQixDQUFDO0lBRUQsUUFBUSxDQUFDLGVBQW1DO1FBQzFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzdCLElBQUssZUFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQzlDLG9CQUFvQjtZQUNwQixPQUFPO1NBQ1I7UUFFRCxNQUFNLFNBQVMsR0FBZ0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVuRSxNQUFNLDJCQUEyQixHQUMvQixlQUFlLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2pFLFNBQVMsQ0FBQyx3QkFBd0IsR0FBRyxDQUNuQyxRQUFnQixFQUNoQixRQUFnQixFQUNoQixPQUE4RCxFQUM5RCxFQUFFO1lBQ0YsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsNEJBQTRCLFFBQVEsSUFBSSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ3JFLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUNsQywyQkFBMkIsRUFDM0IsUUFBUSxFQUNSLFFBQVEsRUFDUixPQUFPLENBQ1IsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUVGLE9BQU8sSUFBSSxLQUFLLENBQUMsZUFBZSxFQUFFO1lBQ2hDLEdBQUcsRUFBRSxDQUNILE1BQVcsRUFDWCxRQUE0RCxFQUM1RCxFQUFFO2dCQUNGLElBQUksUUFBUSxLQUFLLGdCQUFnQixFQUFFO29CQUNqQyxPQUFPLElBQUksQ0FBQztpQkFDYjtnQkFDRCxPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyx3QkFBd0IsQ0FDOUIsUUFBK0QsRUFDL0QsUUFBZ0IsRUFDaEIsUUFBZ0IsRUFDaEIsT0FBOEQ7UUFFOUQsT0FBTyxRQUFRLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMvQyxDQUFDO0NBQ0Y7QUF2R0QsMENBdUdDIn0=